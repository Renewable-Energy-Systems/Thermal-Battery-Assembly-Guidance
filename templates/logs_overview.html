<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Operation Logs · RES</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* ─── 0. Base & M3 Palette ─────────────────────────────────── */
    :root {
        --primary:#3A5BAA;--on-primary:#FFF;
        --primary-container:#D8E2FF;--on-primary-container:#001849;
        --secondary-container:#DBE2F9;--on-secondary-container:#141B2C;
        --error-container:#FFDAD6; --on-error-container:#410002;
        --success-container:#D2F8D3;--on-success-container:#002206;
        --surface:#F8F9FD;--surface-container:#FFF;
        --on-surface:#1A1C1E;--on-surface-variant:#44474F;
        --surface-variant:#F1F3F9;--outline:#DDE2EB;
        --elev-1:0 1px 2px rgba(0,0,0,.08),0 1px 3px 1px rgba(0,0,0,.05);
    }
    *,*:before,*:after{box-sizing:border-box;margin:0;padding:0}
    html{-webkit-font-smoothing:antialiased}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--surface);color:var(--on-surface)}

    /* ─── 2. Shared Components ───────────────────────────────────── */
    .appbar{display:flex;align-items:center;gap:1rem;padding:1rem 1.5rem;background:var(--surface-container);border-bottom:1px solid var(--outline)}
    .appbar img{height:32px;}
    .appbar h1{font-size:1.375rem;font-weight:500;color:var(--on-surface)}
    .content{padding:1.5rem;max-width:1200px;margin:0 auto}
    .card{background:var(--surface-container);border-radius:16px;border:1px solid var(--outline);box-shadow:var(--elev-1);overflow:hidden}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.625rem 1.5rem;border:none;border-radius:100px;font-family:inherit;font-size:.875rem;font-weight:600;text-decoration:none;cursor:pointer;transition:all .2s}
    .btn-primary{background:var(--primary);color:var(--on-primary)}
    .btn-tonal{background:var(--primary-container);color:var(--on-primary-container)}
    .btn svg{width:18px;height:18px;stroke:currentColor;stroke-width:2;fill:none}

    /* ─── 3. Page Layout & Controls ────────────────────────────── */
    .card-header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:1rem;padding:1rem 1.5rem}
    .card-title{font-size:1.5rem;font-weight:600; margin:0;}
    .actions-group{display:flex;flex-wrap:wrap;gap:.75rem}
    .filter-bar{display:flex;flex-wrap:wrap;gap:.75rem;padding:1rem 1.5rem;border-top:1px solid var(--outline);background:var(--surface-variant)}
    .filter-bar input, .filter-bar select{font-family:inherit;font-size:.9rem;padding:.6rem 1rem;border:1px solid var(--outline);border-radius:8px;background:var(--surface-container)}
    .filter-bar .search-input{flex:1 1 250px}

    /* ─── 4. Data Table & Chips ────────────────────────────────── */
    .table-wrapper{overflow-x:auto}
    .data-table{width:100%;border-collapse:collapse}
    .data-table th, .data-table td{padding:.75rem 1.5rem;border-bottom:1px solid var(--outline);text-align:left;white-space:nowrap}
    .data-table thead{background:var(--surface-variant)}
    .data-table th{color:var(--on-surface-variant);font-weight:600}
    .data-table tbody tr{transition:background-color .2s;cursor:pointer}
    .data-table tbody tr:hover{background:rgba(58, 91, 170, 0.04)}
    .chip{display:inline-flex;align-items:center;gap:.35rem;font-size:.75rem;font-weight:600;padding:.2rem .6rem;border-radius:8px}
    .chip svg{width:14px;height:14px}
    .status-finished{color:var(--on-success-container);background:var(--success-container)}
    .status-aborted{color:var(--on-error-container);background:var(--error-container)}

    /* ─── 5. Pagination ──────────────────────────────────────────── */
    .pagination-footer{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-top:1px solid var(--outline)}
    .page-btn{padding:.5rem 1rem;border:1px solid var(--outline);background:var(--surface);border-radius:8px;font-weight:600;cursor:pointer}
    .page-btn[disabled]{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
<header class="appbar">
    <a href="/admin"><img src="/static/logo.png" alt="logo"></a>
    <h1>Operation Logs</h1>
</header>

<main class="content">
<section class="card">
    <div class="card-header">
        <h2 class="card-title">Recent Sessions</h2>
        <div class="actions-group">
            <a class="btn btn-tonal" id="refreshBtn" href="#">
                <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10M1 14l5.87 4.36A9 9 0 0 0 20.49 15"></path></svg>
                <span>Refresh</span>
            </a>
            <a class="btn btn-primary" href="/logs/export">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span>Export All</span>
            </a>
            <a href="/admin" class="btn btn-tonal">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20L4 12l8-8 1.425 1.4-5.6 5.6H20v2H7.825l5.6 5.6Z"/></svg>
                <span>Back to Admin</span>
            </a>
        </div>
    </div>

    <div class="filter-bar">
        <input id="searchInput" class="search-input" placeholder="Search project, stack, or operator...">
        <select id="statusSel">
            <option value="">All Statuses</option>
            <option value="finished">Finished</option>
            <option value="aborted">Aborted</option>
        </select>
        <input type="date" id="fromDate">
        <input type="date" id="toDate">
    </div>

    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Started</th>
                    <th>Project</th>
                    <th>Stack ID</th>
                    <th>Operator</th>
                    <th>Status</th>
                    <th style="text-align:center">Step</th>
                </tr>
            </thead>
            <tbody id="logTableBody">
            {% for r in rows %}
                <tr data-project="{{ r.project|lower }}"
                    data-operator="{{ r.operator|lower }}"
                    data-stack="{{ r.stack_id|lower }}"
                    data-status="{{ r.kind|lower }}"
                    data-date="{{ r.ts[:10] }}"
                    onclick="location.href='/logs/{{ r.session_id }}'">
                    <td>{{ r.ts[:19].replace('T',' ') }}</td>
                    <td>{{ r.project }}</td>
                    <td>{{ r.stack_id }}</td>
                    <td>{{ r.operator }}</td>
                    <td>
                        <span class="chip status-{{ r.kind|lower }}">
                            {% if r.kind == 'finished' %}
                                <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            {% else %}
                                <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            {% endif %}
                            {{ r.kind }}
                        </span>
                    </td>
                    <td style="text-align:center">
                        {{ (r.step + 1) if r.step is not none else '–' }}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-footer">
        <span id="pageInfo"></span>
        <div class="actions-group">
            <button class="page-btn" id="prevBtn">Previous</button>
            <button class="page-btn" id="nextBtn">Next</button>
        </div>
    </div>
</section>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. Data & State
    const allRows = Array.from(document.getElementById('logTableBody').querySelectorAll('tr'));
    let filteredRows = [...allRows];
    let currentPage = 1;
    const rowsPerPage = 10;

    // 2. DOM Elements
    const searchInput = document.getElementById('searchInput');
    const statusSel = document.getElementById('statusSel');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const tableBody = document.getElementById('logTableBody');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // 3. Rendering Logic
    const renderPage = () => {
        tableBody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = filteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:2rem;">No sessions match your filters.</td></tr>`;
        } else {
            paginatedRows.forEach(row => tableBody.appendChild(row));
        }

        const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
        const startItem = filteredRows.length > 0 ? start + 1 : 0;
        const endItem = Math.min(end, filteredRows.length);
        
        pageInfo.textContent = `Showing ${startItem}–${endItem} of ${filteredRows.length}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    };

    // 4. Filtering Logic
    const applyFilters = () => {
        const query = searchInput.value.toLowerCase();
        const status = statusSel.value;
        const from = fromDate.value;
        const to = toDate.value;

        filteredRows = allRows.filter(row => {
            const rowData = row.dataset;
            const textContent = (rowData.project + rowData.stack + rowData.operator).toLowerCase();

            const textMatch = textContent.includes(query);
            const statusMatch = !status || rowData.status === status;
            const dateMatch = (!from || rowData.date >= from) && (!to || rowData.date <= to);

            return textMatch && statusMatch && dateMatch;
        });
        
        currentPage = 1;
        renderPage();
    };

    // 5. Event Listeners
    [searchInput, statusSel, fromDate, toDate].forEach(el => el.addEventListener('input', applyFilters));
    prevBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); }});
    nextBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage < totalPages) { currentPage++; renderPage(); }
    });
    document.getElementById('refreshBtn').addEventListener('click', e => { e.preventDefault(); location.reload(); });

    // Initial Render
    renderPage();
});
</script>
</body>
</html>