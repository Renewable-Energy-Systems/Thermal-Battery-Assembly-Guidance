<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Session Queue · TBAG</title>
<link rel="stylesheet" href="/static/style.css">
<!-- page-specific tweaks … (CSS unchanged except new column widths) -->
<style>
/* … keep all your existing CSS … */
th.device-col, td.device-col {min-width:110px}
</style>
</head>
<body>
<header class="appbar">
  <img src="/static/logo.png" alt="logo">
  <h1>Session Queue</h1>
</header>

<main class="content">
<div class="grid">

  <!-- ═══ Create-form ══════════════════════════════ -->
  <section class="card" style="padding:2.2rem">
    <h2 style="margin-top:0">Create New Session</h2>

    <form action="/admin/sessions/new" method="post"
          class="flex-row" style="gap:.6rem;margin-top:1.4rem;flex-wrap:wrap">
      <!-- project -->
      <select id="projectSel" name="project" required>
        <option value="" disabled selected>Select project…</option>
      </select>

      <!-- device -->
      <select id="deviceSel" name="device">
        <option value="" selected>Any device</option>
      </select>

      <input name="stack_id"  placeholder="Stack ID"  required>
      <input name="operator"  placeholder="Operator" required>
      <button class="btn" style="flex:0 0 auto">Add</button>
    </form>
  </section>

  <!-- ═══ Live table ═══════════════════════════════ -->
  <section class="card" style="padding:2.2rem">
    <h2 style="margin-top:0">Pending / Active Runs</h2>

    <div class="table-wrap" style="margin-top:1rem">
      <table id="sessTbl" class="data-table">
        <thead>
          <tr>
            <th style="min-width:140px">Created</th>
            <th>Project</th>
            <th>Stack</th>
            <th>Operator</th>
            <th class="device-col">Device</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>
</main>

<!-- ═══ JS: populate selects + live refresh ═══════ -->
<script>
/* populate project list */
async function loadProjects(){
  const sel=document.getElementById('projectSel');
  const prev=sel.value;
  const list=await fetch('/projects/json').then(r=>r.json());
  sel.innerHTML='<option value="" disabled>Select project…</option>' +
      list.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(prev) sel.value=prev;
}

/* populate device list */
async function loadDevices(){
  const sel=document.getElementById('deviceSel');
  const prev=sel.value;
  const list=await fetch('/admin/devices/json').then(r=>r.json());
  sel.innerHTML='<option value="">Any device</option>' +
      list.map(d=>`<option value="${d}">${d}</option>`).join('');
  if(prev) sel.value=prev;
}
loadProjects(); loadDevices();
setInterval(loadProjects,5000);
setInterval(loadDevices,5000);

/* live table */
const tbody=document.querySelector('#sessTbl tbody');
function rowMarkup(r){
  const chip=`<span class="chip status-${r.status}">${r.status}</span>`;
  const del=r.status==='pending'
    ? `<form method="post" action="/admin/sessions/${r.session_id}/delete">
         <button class="delete-btn" title="Remove">&#10005;</button>
       </form>` : '';
  return `<tr>
      <td>${r.ts_created.replace('T',' ')}</td>
      <td>${r.project}</td>
      <td>${r.stack_id}</td>
      <td>${r.operator}</td>
      <td class="device-col">${r.device||'–'}</td>
      <td>${chip}</td>
      <td style="text-align:right">${del}</td>
  </tr>`;
}
async function refresh(){
  const rows=await fetch('/admin/sessions/json').then(r=>r.json());
  tbody.innerHTML=rows.map(rowMarkup).join('');
}
refresh(); setInterval(refresh,2500);

/* ripple effect (unchanged) … */
</script>
</body>
</html>
